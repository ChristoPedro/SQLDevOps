version: 0.1
component: command
timeoutInSeconds: 700
shell: bash
failImmediatelyOnError: true
env:
  variables:
    TNS_ADMIN : "/tmp"
  vaultVariables:
    dbpass : ${vault_OCID}
 
inputArtifacts:
  - name: app
    type: GENERIC_ARTIFACT
    registryId: ocid1.artifactrepository.oc1.sa-saopaulo-1.0.amaaaaaatsbrckqa6fmjktavhvjamu3wozh6ey2zkaqjzx3ehaosomnwnpza
    path: apex_app.xml
    version: ${BUILDRUN_HASH}
    location: ${OCI_PRIMARY_SOURCE_DIR}/f${appid}.xml 
  - name: controller
    type: GENERIC_ARTIFACT
    registryId: ocid1.artifactrepository.oc1.sa-saopaulo-1.0.amaaaaaatsbrckqa6fmjktavhvjamu3wozh6ey2zkaqjzx3ehaosomnwnpza
    path: controller.xml
    version: ${BUILDRUN_HASH}
    location: ${OCI_PRIMARY_SOURCE_DIR}/controller.xml  

steps:
  - type: Command
    name: update controller
    shell: /bin/sh
    timeoutInSeconds: 5
    failImmediatelyOnError: true
    command: sed -i "s+{filename.xml}+f${appid}.xml+g" controller.xml
  - type: Command
    timeoutInSeconds: 10
    shell: /bin/sh
    name: "GetWallet"
    command: oci db autonomous-database generate-wallet --autonomous-database-id ${deploy_dbocid} --file adwwallet.zip --password Oracle123456
  - type: Command
    timeoutInSeconds: 30
    shell: /bin/sh
    name: "update variables"
    command: |
      echo "
      set cloudconfig ${PWD}/adwwallet.zip;
      conn ${dbuser}/${dbpass}@${deploy_stringdb}
      declare
      l_workspace_id number;
      begin
      l_workspace_id := apex_util.find_security_group_id (p_workspace => 'demo');
      apex_util.set_security_group_id (p_security_group_id => l_workspace_id);
      APEX_UTIL.PAUSE(2);
      end;
      /
      lb status -changelog-file controller.xml
      lb update -changelog-file controller.xml -debug -log
      " > tmpscript.sql
      cat tmpscript.sql |envsubst > script.sql
  - type: Command
    timeoutInSeconds: 600
    shell: /bin/sh
    name: "update security"
    command:  sql /nolog <script.sql